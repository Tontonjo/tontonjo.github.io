<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ajouter un filigrane</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="bg-slate-900 text-white min-h-screen flex items-center justify-center p-6">

<div class="bg-slate-800 rounded-2xl shadow-2xl p-8 w-full max-w-6xl">
  <h1 class="text-3xl font-bold mb-8 text-center">ü™™ ID Anonymiser</h1>

  <!-- GRID -->
  <div class="grid md:grid-cols-2 gap-8 items-start">

    <!-- GAUCHE : CONTROLES -->
    <div class="space-y-4">

      <div>
        <label class="block mb-1 font-semibold">Charger image ou PDF</label>
        <input id="upload" type="file" accept="image/*,.pdf" class="w-full p-2 rounded bg-slate-700"/>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Texte du filigrane</label>
        <input id="watermarkText" type="text" value="COPIE" class="w-full p-2 rounded bg-slate-700"/>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Couleur du filigrane</label>
        <input id="colorPicker" type="color" value="#808080" class="w-16 h-10 p-1 rounded border-2 border-slate-500"/>
      </div>

      <div>
        <label class="block mb-1 font-semibold">Angle du filigrane</label>
        <div class="flex justify-between text-xs text-slate-300 mb-1">
          <span>0</span><span>180</span><span>360</span>
        </div>
        <input id="angleRange" type="range" min="0" max="360" value="45" class="w-full">
      </div>

      <div>
        <label class="block mb-1 font-semibold">Taille du texte</label>
        <div class="flex justify-between text-xs text-slate-300 mb-1">
          <span>Plus petit</span><span>Plus gros</span>
        </div>
        <input id="sizeRange" type="range" min="0" max="100" value="35" class="w-full">
      </div>

      <div>
        <label class="block mb-1 font-semibold">Transparence</label>
        <div class="flex justify-between text-xs text-slate-300 mb-1">
          <span>Plus transparent</span><span>Plus visible</span>
        </div>
        <input id="opacityRange" type="range" min="0.05" max="1" step="0.05" value="0.75" class="w-full">
      </div>

      <div class="flex gap-4 pt-2">
        <button id="downloadBtn" class="flex-1 bg-green-600 hover:bg-green-700 rounded p-3 font-bold">
          T√©l√©charger
        </button>
      </div>

    </div>

    <!-- DROITE : INFOS + PREVIEW -->
    <div class="space-y-4">

      <div class="bg-slate-900 text-slate-200 p-5 rounded-lg" style="line-height:1.6;font-family:sans-serif">
        <h2 class="text-lg mb-2">üîí Pourquoi ajouter un filigrane ?</h2>
        <p>Avant d'envoyer une pi√®ce d'identit√©, il est recommand√© d'ajouter un filigrane pour :</p>
        <ul class="mt-2 ml-4 list-disc text-sm">
          <li><strong>√âviter l'usurpation :</strong> copie brute r√©utilisable frauduleusement.</li>
          <li><strong>Limiter la r√©utilisation :</strong> dissuader la copie et falsifications.</li>
          <li><strong>Prot√©ger les donn√©es :</strong> indiquer la source (site, num√©ro, etc).</li>
        </ul>
      </div>

      <div class="bg-black rounded-xl p-4 flex items-center justify-center min-h-[500px]">
        <canvas id="canvas" class="max-w-full max-h-[70vh]"></canvas>
      </div>

    </div>
  </div>
</div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const upload = document.getElementById('upload'),
      canvas = document.getElementById('canvas'),
      ctx = canvas.getContext('2d'),
      downloadBtn = document.getElementById('downloadBtn');

const watermarkInput = document.getElementById('watermarkText'),
      sizeRange = document.getElementById('sizeRange'),
      opacityRange = document.getElementById('opacityRange'),
      colorPicker = document.getElementById('colorPicker'),
      angleRange = document.getElementById('angleRange');

let img = new Image(),
    currentType = "image",
    originalCanvas = null;

// Upload fichier
upload.addEventListener('change', async e => {
  const file = e.target.files[0];
  if(!file) return;

  if(file.type === "application/pdf") {
    currentType = "pdf";

    const pdf = await pdfjsLib.getDocument({
      data: await file.arrayBuffer()
    }).promise;

    const page = await pdf.getPage(1);
    const viewport = page.getViewport({scale: 2});

    canvas.width = viewport.width;
    canvas.height = viewport.height;

    await page.render({canvasContext: ctx, viewport}).promise;

    saveOriginal();
    applyWatermark();

  } else {
    currentType = "image";

    const reader = new FileReader();
    reader.onload = e => {
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);

        saveOriginal();
        applyWatermark();
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  }
});

// Sauvegarde original
function saveOriginal() {
  originalCanvas = document.createElement("canvas");
  originalCanvas.width = canvas.width;
  originalCanvas.height = canvas.height;
  originalCanvas.getContext("2d").drawImage(canvas, 0, 0);
}

// Hex vers RGB
function hexToRgb(hex) {
  hex = hex.replace("#","");
  let bigint = parseInt(hex,16);
  return `${(bigint >> 16) & 255},${(bigint >> 8) & 255},${bigint & 255}`;
}

// Appliquer filigrane
function applyWatermark() {
  if(!originalCanvas) return;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.drawImage(originalCanvas,0,0);

  let text = watermarkInput.value.trim() || "COPIE";
  const opacity = opacityRange.value;
  const rgb = hexToRgb(colorPicker.value);
  const angle = angleRange.value * Math.PI / 180;
  const percent = sizeRange.value / 100;
  const fontSize = canvas.width * percent;

  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.rotate(angle);
  ctx.font = `bold ${fontSize}px Arial`;
  ctx.fillStyle = `rgba(${rgb},${opacity})`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText(text, 0, 0);
  ctx.restore();
}

// Live update
watermarkInput.addEventListener('input', applyWatermark);
colorPicker.addEventListener('input', applyWatermark);
sizeRange.addEventListener('input', applyWatermark);
opacityRange.addEventListener('input', applyWatermark);
angleRange.addEventListener('input', applyWatermark);

// T√©l√©charger
downloadBtn.addEventListener('click', () => {
  if(!canvas.width){ alert("Rien √† t√©l√©charger"); return; }

  if(currentType==="pdf"){
    const { jsPDF } = window.jspdf;

    const pdf = new jsPDF({
      orientation:canvas.width>canvas.height?"landscape":"portrait",
      unit:"px",
      format:[canvas.width,canvas.height]
    });

    pdf.addImage(canvas.toDataURL("image/png"),'PNG',0,0,canvas.width,canvas.height);
    pdf.save("document_filigrane.pdf");

  } else {
    const link = document.createElement('a');
    link.download = 'image_filigrane.png';
    link.href = canvas.toDataURL();
    link.click();
  }
});
</script>

</body>
</html>
